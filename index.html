<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Franz • Auto 4K Photo Enhancer</title>
<link rel="icon" href="data:," />
<style>
  :root{
    --bg:#07070a;
    --panel:#0f1216;
    --muted:#96a0b6;
    --accent1:#6ee7b7;
    --accent2:#4A90E2;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;background:
    radial-gradient(800px 300px at 10% 10%, rgba(74,144,226,0.06), transparent),
    linear-gradient(180deg,var(--bg), #04050a); color:#e6eef8}
  .wrap{max-width:980px;margin:40px auto;padding:26px;border-radius:14px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 18px 60px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.02)}
  header{display:flex;gap:14px;align-items:center}
  .logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center;color:#021;font-weight:900;font-size:28px}
  h1{margin:0;font-size:20px}
  p.lead{margin:2px 0 0;color:var(--muted);font-size:13px}
  .controls{margin-top:20px;display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .filebox{flex:1;min-width:240px}
  input[type=file]{width:100%;padding:12px;border-radius:10px;border:1px dashed var(--glass);background:transparent;color:inherit;outline:none}
  .status{margin-top:18px;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.0));border:1px solid rgba(255,255,255,0.02);color:var(--muted);font-size:14px}
  .preview{margin-top:20px;text-align:center}
  img#out{max-width:100%;border-radius:12px;box-shadow:0 24px 60px rgba(2,6,23,0.7)}
  .small{font-size:12px;color:var(--muted);margin-top:8px}
  .btn{display:inline-block;margin-top:12px;padding:10px 16px;border-radius:12px;background:linear-gradient(90deg,var(--accent2),var(--accent1));color:#021;font-weight:800;text-decoration:none}
  footer{margin-top:18px;text-align:center;color:var(--muted);font-size:12px}
  @media(max-width:720px){
    .wrap{margin:20px;padding:18px}
    header{gap:10px}
    .logo{width:56px;height:56px;font-size:24px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">F</div>
      <div>
        <h1>Franz • Auto 4K Photo Enhancer</h1>
        <p class="lead">Upload a photo. Cloud AI (Real-ESRGAN + face restore) upscales & enhances automatically — download when finished.</p>
      </div>
    </header>

    <div class="controls">
      <div class="filebox">
        <input id="file" type="file" accept="image/*">
        <div class="small">Supported: JPG, PNG, WebP. Proportional upscale until at least 3840×2160 (4K). No manual settings.</div>
      </div>
    </div>

    <div id="status" class="status">Waiting for image…</div>

    <div id="preview" class="preview" style="display:none">
      <img id="out" alt="Enhanced preview">
      <div><a id="download" class="btn" href="#" style="display:none">Download Enhanced</a></div>
      <div class="small" id="info"></div>
    </div>

    <footer>Tip: For best results, use original photos (not screenshots). Regenerate your Replicate token later for security.</footer>
  </div>

<script>
/* -------------------------
   CONFIG: Insert your API token below.
   You asked to include it directly; it's set now.
   (If you later want to regenerate your token, update this value.)
   ------------------------- */
const REPLICATE_TOKEN = "r8_IUEHEc1yTgQgBuP4nJvszMU8nbCDnzM3wPZRI";

/* Model version: Real-ESRGAN public version that supports scale & face_enhance */
const MODEL_VERSION = "replicategithubwc/real-esrgan:c23d87a7029d3cfc74b2b5796660676083d236cba2de36a2ce9d9e08e637cabe";

const fileEl = document.getElementById('file');
const statusEl = document.getElementById('status');
const previewEl = document.getElementById('preview');
const outImg = document.getElementById('out');
const downloadBtn = document.getElementById('download');
const info = document.getElementById('info');

if (!REPLICATE_TOKEN || REPLICATE_TOKEN.startsWith("r8_") === false) {
  statusEl.textContent = "⚠️ API token missing or looks invalid. Put your Replicate token into the REPLICATE_TOKEN constant.";
}

fileEl.addEventListener('change', async () => {
  const file = fileEl.files && fileEl.files[0];
  if (!file) return;
  previewEl.style.display = 'none';
  downloadBtn.style.display = 'none';
  statusEl.textContent = 'Reading image…';

  try {
    const dataUrl = await readFileAsDataURL(file);
    const img = await createImage(dataUrl);
    statusEl.textContent = 'Calculating upscale factor…';

    const targetW = 3840, targetH = 2160;
    const scaleNeeded = Math.ceil(Math.max(targetW / img.width, targetH / img.height, 1));
    const scale = Math.min(10, scaleNeeded); // clamp to model max
    statusEl.textContent = `Requested scale: ${scale}x — sending to cloud AI (best-quality model)...`;

    // create prediction
    const createResp = await fetch('https://api.replicate.com/v1/predictions', {
      method: 'POST',
      headers: {
        'Authorization': 'Token ' + REPLICATE_TOKEN,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        version: MODEL_VERSION,
        input: {
          image: dataUrl,
          scale: scale,
          face_enhance: true
        }
      })
    });

    if (!createResp.ok) {
      const t = await createResp.text();
      throw new Error('Failed to create prediction: ' + t);
    }

    const prediction = await createResp.json();
    statusEl.textContent = 'Processing on cloud — this may take a while depending on queue...';

    // poll
    let resultUrl = null;
    while (true) {
      await sleep(1800);
      const poll = await fetch('https://api.replicate.com/v1/predictions/' + prediction.id, {
        headers: { 'Authorization': 'Token ' + REPLICATE_TOKEN }
      });
      const data = await poll.json();
      if (data.status === 'succeeded') {
        resultUrl = Array.isArray(data.output) ? data.output[0] : data.output;
        break;
      } else if (data.status === 'failed') {
        throw new Error('Server-side enhancement failed.');
      } else {
        statusEl.textContent = 'Status: ' + data.status + ' — waiting...';
      }
    }

    if (!resultUrl) throw new Error('No result URL from model.');

    statusEl.textContent = 'Downloading enhanced image from cloud…';
    const enhancedResp = await fetch(resultUrl);
    const enhancedBlob = await enhancedResp.blob();

    statusEl.textContent = 'Auto-compressing (keep quality, reduce size)…';
    const finalBlob = await compressImageBlob(enhancedBlob, 0.92);

    const objUrl = URL.createObjectURL(finalBlob);
    outImg.src = objUrl;
    previewEl.style.display = 'block';
    downloadBtn.href = objUrl;
    downloadBtn.download = (file.name.replace(/\.[^.]+$/, '') || 'enhanced') + '-4k.jpg';
    downloadBtn.style.display = 'inline-block';
    statusEl.textContent = 'Done — enhanced image ready. If download didn’t start, tap Download.';
    autoDownload(objUrl, downloadBtn.download);

    info.textContent = `Original: ${img.width}×${img.height} → scale: ${scale}x. Output size: ${Math.round(finalBlob.size/1024)} KB`;
  } catch (err) {
    console.error(err);
    statusEl.textContent = 'Error: ' + (err.message || err);
  }
});

/* ---------- helpers ---------- */
function readFileAsDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
function createImage(dataUrl){ return new Promise((res,rej)=>{ const img=new Image(); img.onload=()=>res(img); img.onerror=rej; img.src=dataUrl; }); }
function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

async function compressImageBlob(blob, quality=0.92){
  const dataUrl = await blobToDataURL(blob);
  const img = await createImage(dataUrl);
  // cap to avoid memory issues
  const maxDim = 8192;
  let w = img.width, h = img.height;
  if (Math.max(w,h) > maxDim) {
    const factor = maxDim / Math.max(w,h);
    w = Math.round(w*factor); h = Math.round(h*factor);
  }
  const canvas = document.createElement('canvas');
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(img, 0, 0, w, h);
  return new Promise(res => canvas.toBlob(res, 'image/jpeg', quality));
}
function blobToDataURL(blob){ return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(blob); }); }

function autoDownload(url, filename){
  try {
    const a = document.createElement('a');
    a.href = url; a.download = filename; document.body.appendChild(a);
    a.click(); a.remove();
  } catch(e){}
}
</script>
</body>
</html>
